#!/bin/execlineb -P

backtick -D "/app /config /defaults" DEFAULT_DIR {
	printcontenv DEFAULT_DIR
}
backtick -E USER { printcontenv __USER }
if {
	redirfd -w 1 /dev/null
	foreground {
		backtick -D "-1" -E UID { printcontenv __UID }
		if -t { s6-test ${UID} -ge 0 }
		usermod -o -u ${UID} ${USER}
	}
	importas -iu UID_EXIT ?
	foreground {
		backtick -D "-1" -E GID { printcontenv __GID }
		if -t { s6-test ${GID} -ge 0 }
		groupmod -o -g ${GID} ${USER}
	}
	importas -iu GID_EXIT ?
	backtick -D 126 -E CODE {
		foreground { s6-expr ${UID_EXIT} + ${GID_EXIT} }
	}
	exit ${CODE}
}
backtick -E CONTENV_DIR { mktemp -u }
foreground { with-contenv s6-dumpenv ${CONTENV_DIR} }
if {
	importas -isu DEFAULT_DIR DEFAULT_DIR
	forx -o 0 -p -E dir { ${DEFAULT_DIR} }
	if -n { s6-test -f ${dir} }
	if { s6-mkdir -p ${dir} }
	backtick -E md5sum {
		pipeline { heredoc 0 ${dir} md5sum }
		awk "{print $1}"
	}
	redirfd -w 1 "${CONTENV_DIR}/__CONF-${md5sum}" s6-echo ${dir}
}
elglob -s0 conf "${CONTENV_DIR}/*[cC][oO][nN][fF]*"
forx -o 0 -p -E key { ${conf} }
backtick -E value { redirfd -r 0 ${key} s6-cat }
if -t { s6-test -d ${value} }
if -t { s6-test -w ${value} }
chown -R ${USER}:${USER} ${value}
